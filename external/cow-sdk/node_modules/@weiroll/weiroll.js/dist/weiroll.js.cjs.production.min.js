"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@ethersproject/abi"),e=require("@ethersproject/properties"),n=require("@ethersproject/bytes");function r(t,e){return(r=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function a(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function o(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return a(t,void 0);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?a(t,void 0):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0;return function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=function(t,e){this.param=t,this.value=e},l=function(t,e){this.param=t,this.command=e},c=function(){this.param=t.ParamType.from("bytes[]")},u=function(e){this.param=t.ParamType.from("bytes[]"),this.planner=e};!function(t){t[t.DELEGATECALL=0]="DELEGATECALL",t[t.CALL=1]="CALL",t[t.STATICCALL=2]="STATICCALL",t[t.CALL_WITH_VALUE=3]="CALL_WITH_VALUE",t[t.CALLTYPE_MASK=3]="CALLTYPE_MASK",t[t.EXTENDED_COMMAND=64]="EXTENDED_COMMAND",t[t.TUPLE_RETURN=128]="TUPLE_RETURN"}(i||(i={}));var f=function(){function e(t,e,n,r,a){this.contract=t,this.flags=e,this.fragment=n,this.args=r,this.callvalue=a}var n=e.prototype;return n.withValue=function(n){if((this.flags&i.CALLTYPE_MASK)!==i.CALL&&(this.flags&i.CALLTYPE_MASK)!==i.CALL_WITH_VALUE)throw new Error("Only CALL operations can send value");return new e(this.contract,this.flags&~i.CALLTYPE_MASK|i.CALL_WITH_VALUE,this.fragment,this.args,h(n,t.ParamType.from("uint")))},n.rawValue=function(){return new e(this.contract,this.flags|i.TUPLE_RETURN,this.fragment,this.args,this.callvalue)},n.staticcall=function(){if((this.flags&i.CALLTYPE_MASK)!==i.CALL)throw new Error("Only CALL operations can be made static");return new e(this.contract,this.flags&~i.CALLTYPE_MASK|i.STATICCALL,this.fragment,this.args,this.callvalue)},e}();function p(t){return void 0!==t&&["string","bytes","array","tuple"].includes(t.baseType)}function h(e,r){if(function(t){return void 0!==t.param}(e)){if(e.param.type!==r.type)throw new Error("Cannot pass value of type "+e.param.type+" to input of type "+r.type);return e}return e instanceof v?new u(e):function(e,r){return p(e)?new s(e,n.hexDataSlice(t.defaultAbiCoder.encode([e],[r]),32)):new s(e,t.defaultAbiCoder.encode([e],[r]))}(r,e)}function m(t,e){return function(){for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];if(r.length!==e.inputs.length)throw new Error("Function "+e.name+" has "+e.inputs.length+" arguments but "+r.length+" provided");var o=r.map((function(t,n){return h(t,e.inputs[n])}));return new f(t,t.commandflags,e,o)}}var d,g=function(t){var e,n;function a(){return t.apply(this,arguments)||this}return n=t,(e=a).prototype=Object.create(n.prototype),e.prototype.constructor=e,r(e,n),a}(function(){function n(t,r,a){var o=this;if(this.interface=e.getStatic(this instanceof n?this.constructor:void 0,"getInterface")(r),0!=(a&~i.CALLTYPE_MASK))throw new Error("Only calltype flags may be supplied to BaseContract constructor");this.address=t,this.commandflags=a,this.functions={};var s={},l={};Object.keys(this.interface.functions).forEach((function(t){var n=o.interface.functions[t];if(l[t])throw new Error("Duplicate ABI entry for "+JSON.stringify(t));l[t]=!0;var r=n.name;s[r]||(s[r]=[]),s[r].push(t),null==o[t]&&e.defineReadOnly(o,t,m(o,n)),null==o.functions[t]&&e.defineReadOnly(o.functions,t,m(o,n))})),Object.keys(s).forEach((function(t){var n=s[t];if(!(n.length>1)){var r=n[0];try{null==o[t]&&e.defineReadOnly(o,t,o[r])}catch(t){}null==o.functions[t]&&e.defineReadOnly(o.functions,t,o.functions[r])}}))}return n.createContract=function(t,e){return void 0===e&&(e=i.CALL),new g(t.address,t.interface,e)},n.createLibrary=function(t){return new g(t.address,t.interface,i.DELEGATECALL)},n.getInterface=function(e){return t.Interface.isInterface(e)?e:new t.Interface(e)},n}());!function(t){t[t.CALL=0]="CALL",t[t.RAWCALL=1]="RAWCALL",t[t.SUBPLAN=2]="SUBPLAN"}(d||(d={}));var L=function(t,e){this.call=t,this.type=e};function A(t,e,n){return t.concat(new Array(e-t.length).fill(n))}var v=function(){function e(){this.state=new c,this.commands=[]}var r=e.prototype;return r.add=function(e){var n,r=new L(e,d.CALL);this.commands.push(r);for(var a,s=o(e.args);!(a=s()).done;)if(a.value instanceof u)throw new Error("Only subplans can have arguments of type SubplanValue");return e.flags&i.TUPLE_RETURN?new l(t.ParamType.fromString("bytes"),r):1!==(null==(n=e.fragment.outputs)?void 0:n.length)?null:new l(e.fragment.outputs[0],r)},r.addSubplan=function(t){for(var e,n,r=!1,a=!1,i=o(t.args);!(n=i()).done;){var s=n.value;if(s instanceof u){if(r)throw new Error("Subplans can only take one planner argument");r=!0}if(s instanceof c){if(a)throw new Error("Subplans can only take one state argument");a=!0}}if(!r||!a)throw new Error("Subplans must take planner and state arguments");if(!r||!a)throw new Error("Subplans must take planner and state arguments");if(1===(null==(e=t.fragment.outputs)?void 0:e.length)&&"bytes[]"!==t.fragment.outputs[0].type)throw new Error("Subplans must return a bytes[] replacement state or nothing");this.commands.push(new L(t,d.SUBPLAN))},r.replaceState=function(t){var e;if(1!==(null==(e=t.fragment.outputs)?void 0:e.length)||"bytes[]"!==t.fragment.outputs[0].type)throw new Error("Function replacing state must return a bytes[]");this.commands.push(new L(t,d.RAWCALL))},r.preplan=function(t,e,n,r){if(void 0===n&&(n=new Set),void 0===r&&(r=new Set),r.has(this))throw new Error("A planner cannot contain itself");r.add(this);for(var a,f=o(this.commands);!(a=f()).done;){var p=a.value,h=p.call.args;if((p.call.flags&i.CALLTYPE_MASK)===i.CALL_WITH_VALUE){if(!p.call.callvalue)throw new Error("Call with value must have a value parameter");h=[p.call.callvalue].concat(h)}for(var m,d=o(h);!(m=d()).done;){var g=m.value;if(g instanceof l){if(!n.has(g.command))throw new Error('Return value from "'+g.command.call.fragment.name+'" is not visible here');t.set(g.command,p)}else if(g instanceof s)e.set(g.value,p);else if(g instanceof u){var L=n;p.call.fragment.outputs&&0!==p.call.fragment.outputs.length||(L=new Set(n)),g.planner.preplan(t,e,L,r)}else if(!(g instanceof c))throw new Error("Unknown function argument type '"+typeof g+"'")}n.add(p)}return{commandVisibility:t,literalVisibility:e}},r.buildCommandArgs=function(t,e,n,r){var a=t.call.args;if((t.call.flags&i.CALLTYPE_MASK)===i.CALL_WITH_VALUE){if(!t.call.callvalue)throw new Error("Call with value must have a value parameter");a=[t.call.callvalue].concat(a)}var o=new Array;return a.forEach((function(t){var a;if(t instanceof l)a=e.get(t.command);else if(t instanceof s)a=n.get(t.value);else if(t instanceof c)a=254;else{if(!(t instanceof u))throw new Error("Unknown function argument type '"+typeof t+"'");a=r.length-1}p(t.param)&&(a|=128),o.push(a)})),o},r.buildCommands=function(e){for(var r,a=new Array,s=o(this.commands);!(r=s()).done;){var l=r.value;if(l.type===d.SUBPLAN){var c=l.call.args.find((function(t){return t instanceof u})).planner.buildCommands(e);e.state.push(n.hexDataSlice(t.defaultAbiCoder.encode(["bytes32[]"],[c]),32)),e.freeSlots.push(e.state.length-1)}var f=l.call.flags,h=this.buildCommandArgs(l,e.returnSlotMap,e.literalSlotMap,e.state);h.length>6&&(f|=i.EXTENDED_COMMAND),e.freeSlots=e.freeSlots.concat(e.stateExpirations.get(l)||[]);var m=255;if(e.commandVisibility.has(l)){var g;if(l.type===d.RAWCALL||l.type===d.SUBPLAN)throw new Error("Return value of "+l.call.fragment.name+" cannot be used to replace state and in another function");m=e.state.length,e.freeSlots.length>0&&(m=e.freeSlots.pop()),e.returnSlotMap.set(l,m);var L=e.commandVisibility.get(l);e.stateExpirations.set(L,(e.stateExpirations.get(L)||[]).concat([m])),m===e.state.length&&e.state.push("0x"),(p(null==(g=l.call.fragment.outputs)?void 0:g[0])||0!=(l.call.flags&i.TUPLE_RETURN))&&(m|=128)}else l.type!==d.RAWCALL&&l.type!==d.SUBPLAN||l.call.fragment.outputs&&1===l.call.fragment.outputs.length&&(m=254);(f&i.EXTENDED_COMMAND)===i.EXTENDED_COMMAND?(a.push(n.hexConcat([l.call.contract.interface.getSighash(l.call.fragment),[f,0,0,0,0,0,0,m],l.call.contract.address])),a.push(n.hexConcat([A(h,32,255)]))):a.push(n.hexConcat([l.call.contract.interface.getSighash(l.call.fragment),[f],A(h,6,255),[m],l.call.contract.address]))}return a},r.plan=function(){var t=new Map,e=new Map;this.preplan(e,t);var n=new Map,r=new Map,a=new Array;t.forEach((function(t,e){var o=a.length;a.push(e),r.set(e,o),n.set(t,(n.get(t)||[]).concat([o]))}));var o={returnSlotMap:new Map,literalSlotMap:r,freeSlots:new Array,stateExpirations:n,commandVisibility:e,state:a};return{commands:this.buildCommands(o),state:a}},e}();exports.Contract=g,exports.FunctionCall=f,exports.Planner=v;
//# sourceMappingURL=weiroll.js.cjs.production.min.js.map
