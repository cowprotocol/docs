---
sidebar_position: 5
---

# Flash loans

We’ll walk through a concrete example of a debt repayment using flash loans on Sepolia.

There is an [example order](https://explorer.cow.fi/sepolia/orders/0x86ff28a37bf70c549edfe753d899d44307b1b4c3ae943c6f5bdfe271942fd4f135ed9a9d1122a1544e031cc92fcc7ea599e28d9c67dc66ab) for this particular case on Sepolia, including the [corresponding on-chain transaction](https://sepolia.etherscan.io/tx/0x6f4fc9b450e08dab0ab2d935e7c7dcade9e44e330e484657e5b1fadb6c6e8851).
The example was executed using an [automated script](https://github.com/mrnaveira/cow-flashloan-tester) that places and signs a flash loan order on the Sepolia network. The following sections of the tutorial include code snippets from this tool.

## Setup
The setup for the flash loan example is as follows:
* A Safe wallet at address 0x35eD9A9D1122A1544e031Cc92fCC7eA599e28D9C. We use a smart contract wallet so that smart contracts can initiate the withdrawal of the collateral token.
* The Safe borrows 10,000 USDT on Aave using 500,000 USDC as collateral.
* Aave is used as the flash loan lender.
* The necessary `ERC-20` approvals are set in the wallet — to CoW's Vault Relayer contract and to the relevant Aave pool contracts.
* Some non-zero amount of the order's buy token in the Safe's balance, to pass CoW Swap order validation.

The order itself intends to:
1. Request a flash loan to Aave of 5,000 USDT.
2. Use those 5,000 to partially repay the 10,000 USDT debt on Aave.
3. Withdraw 400,000 USDC from Aave.
4. Perform a trade on CoW Swap, selling up to 400,000 USDC for 5,002.5 USDT (borrowed amount + [0.05% flash loan fee on Aave](https://aave.com/docs/concepts/flash-loans)).
2. Use the 5,002.5 USDT from the trade to fully repay the flash loan (including the fee).

:::info

Exchange ratios on the Sepolia network can be very inconsistent. To ensure successful execution of the order, a large amount of USDC is withdrawn from Aave and used in the trade.

General considerations when testing flash loans on Sepolia and Aave:
- [Token addresses in Aave may not correspond](https://github.com/mrnaveira/cow-flashloan-tester?tab=readme-ov-file#2-select-aave-tokens) with tokens names in other dapps.
- [Token ratios](https://github.com/mrnaveira/cow-flashloan-tester?tab=readme-ov-file#4-determine-token-amounts-needed-to-trade-and-deposit) may need to be balanced, and trading amounts adjusted accordingly.
- Tokens in Aave can be [obtained from the faucet](https://github.com/mrnaveira/cow-flashloan-tester?tab=readme-ov-file#5-get-tokens-from-the-faucet).
- Check [withdrawal and borrowing availability](https://github.com/mrnaveira/cow-flashloan-tester?tab=readme-ov-file#7-check-aaves-withdrawalborrow-availability) of the tokens on Aave.

In a production network (e.g. mainnet), these considerations generally won’t apply.

:::

## Aave repay pre-hook
We need to define a [pre-hook](/cow-protocol/reference/core/intents/hooks) to repay the 5,000 USDT debt on Aave.

As part of the settlement, we want to call the [`repay` function on Aave's pool](https://aave.com/docs/developers/smart-contracts/pool#write-methods-repay):
```solidity
function repay(
    address asset,
    uint256 amount,
    uint256 interestRateMode,
    address onBehalfOf
) public virtual override returns (uint256)
```

The following Typescript code generates the corresponding function data using [`viem`](https://viem.sh/):
```typescript
const repayTxData = encodeFunctionData({
    abi, // ABI definition for the repay function
    functionName: 'repay',
    args: [
      '0xaA8E23Fb1079EA71e0a56F48a2aA51851D8433D0', // asset: USDT
      '5000000000', // amount: 5,000 USDT (USDT has 6 decimals)
      2, // interestRateMode: 2 for variable
      '0x35eD9A9D1122A1544e031Cc92fCC7eA599e28D9C', // onBehalfOf: Safe address
    ]
  });
```

The `repay` call must be executed during the order settlement process. To enable this, the pre-hook defines a transaction that will be sent to the Safe wallet. The Safe then executes the actual repay call to the Aave pool.
The transaction can be built as shown below:
```typescript
  const repaySafeTxData: SafeTransactionDataPartial = {
    to: '0x6Ae43d3271ff6888e7Fc43Fd7321a503ff738951', // Aave pool address in Sepolia,
    value: '0',
    data: repayTxData, // created previously
    operation: OperationType.Call,
    nonce, // current Safe nonce + 1
  };

  const safeTransaction = await safe.createTransaction({ transactions: [repaySafeTxData] });
  const signedSafeTransaction = await safe.signTransaction(safeTransaction, SigningMethod.ETH_SIGN);
  const encodedSafeTransaction = await safe.getEncodedTransaction(signedSafeTransaction);
```

:::note
For this example, the `nonce` should be offset by 1 from the current Safe's nonce, as this transaction will be executed in the future.
This is needed to avoid using the same nonce twice, as we will send another transaction for the pre-signature in following sections.
:::

## Aave withdraw pre-hook
We need to define another pre-hook to withdraw 400,000 USDC from the Aave deposit, needed for the trade.

For this, we need to call the [`withdraw` function on Aave's pool](https://aave.com/docs/developers/smart-contracts/pool#write-methods-withdraw):
```solidity
function withdraw(
    address asset,
    uint256 amount,
    address to
) public virtual override returns (uint256)
```

The corresponding function data can be created as follows:
```typescript
  const txData = encodeFunctionData({
    abi, // ABI definition for the withdraw function
    functionName: 'withdraw',
    args: [
      '0x94a9d9ac8a22534e3faca9f4e7f2e2cf85d5e4c8', // asset: USDC
      '400000000000', // amount: 400,000 USDC (USDC has 6 decimals)
      '0x35eD9A9D1122A1544e031Cc92fCC7eA599e28D9C', // to: Safe address
    ]
  });
```

Like in the previous section, the `withdraw` call will be executed during the order settlement process via a Safe transaction, and can be built with:
```typescript
  const safeTxData: SafeTransactionDataPartial = {
    to: '0x6Ae43d3271ff6888e7Fc43Fd7321a503ff738951', // Aave pool address in Sepolia,
    value: '0',
    data: txData, // created previously
    operation: OperationType.Call,
    nonce, // current Safe nonce + 2
  }

  const safeTransaction = await safe.createTransaction({ transactions: [safeTxData] })
  const signedSafeTransaction = await safe.signTransaction(safeTransaction, SigningMethod.ETH_SIGN);
  const encodedSafeTransaction = await safe.getEncodedTransaction(signedSafeTransaction);

  return encodedSafeTransaction;
```
:::note
Just like the `repay` pre-hook, the `nonce` should be incremented to ensure it doesn't conflict with other transactions. Here, we increase it by 2 because there are two preceding transactions: the pre-signature and the `repay` pre-hook.
:::

## Order construction

```json5
{
  "from": "Safe address",
  "sellToken": "USDC address", // collateral token (unlocked by repaying the debt)
  "buyToken": "USDT address", // originally borrowed token that was now advanced by the flash loan
  "buyAmount": 5002500000, // appData.flashloan.amount + 0.05% flashloan fee
  "receiver": "settlementContract", // this is for repaying the flash loan
  "validTo": "now + 5m", // managing risk can be done by having a short validity
  "kind": "buy", // buy exactly the flash loaned amount and keep the surplus in the collateral token
  "partiallyFillable": false, // if an order is partially fillable, then it is not ensured the debt will be paid
  "appData": {
    "hooks": {
      "pre": [
         // First: Repay the debt
         {
            "target": "0x123...321",
            "value": "0",
            "callData": "signedRepayCall"
         },
         // Then: Withdraw the collateral
         {
            "target": "0x123...321",
            "value": "0",
            "callData": "signedWithdrawCall"
         }
      ]
    },
    "flashloan": {
      "token": "USDT",
      "amount": 5000000000 // 5,000 USDT in atoms
    }
  }
}
```

This example relies on a pre-signature, but a valid EIP-1271 contract signature could also be used.

Check the [flash loan tester script](https://github.com/mrnaveira/cow-flashloan-tester) for more details on how this order is constructed.

## Setting the pre-signature of the order

After the order is placed, its pre-signature must be submitted to the CoW Settlement Contract via a transaction:
* Function [`setPresignature`](https://docs.cow.fi/cow-protocol/reference/contracts/core/settlement#setpresignature).
* Arguments: `orderId` and `true`.

The [flash loan tester script](https://github.com/mrnaveira/cow-flashloan-tester) already sends this transaction automatically to be executed by the Safe. You can see an example of this transaction [here](https://sepolia.etherscan.io/tx/0x2de6e4cfcf61942f73e2db254a6b917fc52ec95da4d296f5a998be4c1b910c94).

After the pre-signature transaction is confirmed, the order's status will be `Open`, and it will be eligible for execution within the CoW Protocol.

## Order execution

Once an order is placed within the CoW Protocol, it enters an auction batch. When a solution is found, the following steps occur:

1. The winning solver calls the flash loan `IFlashLoanRouter` contract.
2. The 5,000 USDT gets transferred to the flash loan `IFlashLoanRouter` contract.
3. In the pre-hook:
    - Transfer 5,000 USDC from the flash loan `IFlashLoanRouter` contract to the user.
    - Execute the user's pre-hook: Repay the outstanding debt.
    - The user receives their 400,000 USDC of collateral.
4. Transfer funds into the settlement contract.
5. Execute the user's order:
    - Swap USDC for USDT.
6. Transfer funds to the `receiver` address (funds are sent to the settlement contract, which is to itself).
7. Execute the post-interaction
    - Depending on the flash loan provider, either pay back 5,002.5 USDT to the flash loan provider from the settlement contract, or send the funds to the flash loan `IFlashLoanRouter` contract, and then send it to the flash loan provider.

State after the order's execution:
- Some USDC may remain in the user’s wallet as surplus.
- On Aave: 
    - The USDT debt is reduced from 10,000 to 5,000.
    - The USDC collateral is reduced by 400,000.
- The flash loan provider is fully repaid (5,002.5 USDT).