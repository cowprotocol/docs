---
sidebar_position: 5
---

# Flash loans

The general setup for a flash loan requires:
* A smart contract wallet (e.g. Safe Wallet).
* A flash loan lender (e.g. Aave).
* A use case for the funds (e.g. repaying a debt in Aave using a deposit as collateral).
* The necessary `ERC-20` approvals in the wallet: to CoW's Vault Relayer contract, as well as any additional approvals related to the use case (e.g. Aave pools).
* Some non-zero amount of the order's buy token in the wallet balance, to pass CoW Swap order validation.

## Example: repay debt with collateral using flash loans on Sepolia

We’ll walk through a concrete example of a debt repayment using flash loans on Sepolia.

There is an [example order](https://explorer.cow.fi/sepolia/orders/0x86ff28a37bf70c549edfe753d899d44307b1b4c3ae943c6f5bdfe271942fd4f135ed9a9d1122a1544e031cc92fcc7ea599e28d9c67dc66ab) for a particular case on Sepolia, including the [corresponding onchain transaction](https://sepolia.etherscan.io/tx/0x6f4fc9b450e08dab0ab2d935e7c7dcade9e44e330e484657e5b1fadb6c6e8851).
The example was executed using an [automated script](https://github.com/mrnaveira/cow-flashloan-tester) that places and signs a flash loan order on the Sepolia network.

### Test setup
The setup for the flash loan example is as follows:
* A safe Wallet on address `0x35eD9A9D1122A1544e031Cc92fCC7eA599e28D9C`.
* The Safe borrows 10,000 USDT on Aave using 500,000 USDC as collateral.

The order itself intends to:
1. Request a flash loan to Aave of 5,000 USDT.
2. Use those 5,000 to partially repay the 10,000 USDT debt on Aave.
3. Withdraw 400,000 USDC from Aave.
4. Perform a trade on CoW Swap, selling up to 400,000 USDC for 5,002.5 USDT (borrowed amount + [0.05% flash loan fee on Aave](https://aave.com/docs/concepts/flash-loans)).
2. Use the 5,002.5 USDT from the trade to fully repay the flash loan (including the fee).

:::info

Exchange ratios on the Sepolia network can be very inconsistent. To ensure successful execution of the order, a large amount of USDC is withdrawn from Aave and used in the trade.

General considerations when testing flash loans on Sepolia and Aave:
- [Token addresses in Aave may not correspond](https://github.com/mrnaveira/cow-flashloan-tester?tab=readme-ov-file#2-select-aave-tokens) with tokens names in other dapps.
- [Token ratios](https://github.com/mrnaveira/cow-flashloan-tester?tab=readme-ov-file#4-determine-token-amounts-needed-to-trade-and-deposit) may need to be balanced, and trading amounts adjusted accordingly.
- Tokens in Aave can be [obtained from the faucet](https://github.com/mrnaveira/cow-flashloan-tester?tab=readme-ov-file#5-get-tokens-from-the-faucet).
- Check [withdrawal and borrowing availability](https://github.com/mrnaveira/cow-flashloan-tester?tab=readme-ov-file#7-check-aaves-withdrawalborrow-availability) of the tokens on Aave.

In a production network (e.g. mainnet), these considerations generally won’t apply.

:::

### Order construction

```json5
{
  "from": "Safe address",
  "sellToken": "USDC address", // collateral token (unlocked by repaying the debt)
  "buyToken": "USDT address", // originally borrowed token that was now advanced by the flash loan
  "buyAmount": 5002500000, // appData.flashloan.amount + 0.05% flashloan fee
  "receiver": "settlementContract", // this is for repaying the flash loan
  "validTo": "now + 5m", // managing risk can be done by having a short validity
  "kind": "buy", // buy exactly the flash loaned amount and keep the surplus in the collateral token
  "partiallyFillable": false, // if an order is partially fillable, then it is not ensured the debt will be paid
  "appData": {
    "hooks": {
      "pre": [
         // First: Repay the debt
         {
            "target": "0x123...321",
            "value": "0",
            "callData": "signedRepayCall"
         },
         // Then: Withdraw the collateral
         {
            "target": "0x123...321",
            "value": "0",
            "callData": "signedWithdrawCall"
         }
      ]
    },
    "flashloan": {
      "token": "USDT",
      "amount": 5000000000 // 5,000 USDT in atoms
    }
  }
}
```

Check the [flash loan tester script](https://github.com/mrnaveira/cow-flashloan-tester) for more details on how this order is constructed.

### Setting the pre-signature of the order

After the order is placed, its pre-signature must be submitted to the CoW Settlement Contract via a transaction:
* Function [`setPresignature`](https://docs.cow.fi/cow-protocol/reference/contracts/core/settlement#setpresignature).
* Arguments: `orderId` and `true`.

The [flash loan tester script](https://github.com/mrnaveira/cow-flashloan-tester) already sends this transaction automatically to be executed by the Safe. You can see an example of this transaction [here](https://sepolia.etherscan.io/tx/0x2de6e4cfcf61942f73e2db254a6b917fc52ec95da4d296f5a998be4c1b910c94).

After the pre-signature transaction is confirmed, the order's status will be `Open`, and it will be eligible for execution within the CoW Protocol.

### Order execution

Once an order is placed within the CoW Protocol, it enters an auction batch. When a solution is found, the following steps occur:

1. The winning solver calls the flash loan `IFlashLoanRouter` contract.
2. The 5,000 USDT gets transferred to the flash loan `IFlashLoanRouter` contract.
3. In the pre-hook:
    - Transfer 5,000 USDC from the flash loan `IFlashLoanRouter` contract to the user.
    - Execute the user's pre-hook: Repay the outstanding debt.
    - The user receives their 400,000 USDC of collateral.
4. Transfer funds into the settlement contract.
5. Execute the user's order:
    - Swap USDC for USDT.
6. Transfer funds to the `receiver` address (funds are sent to the settlement contract, which is to itself).
7. Execute the post-interaction
    - Depending on the flash loan provider, either pay back 5,002.5 USDT to the flash loan provider from the settlement contract, or send the funds to the flash loan `IFlashLoanRouter` contract, and then send it to the flash loan provider.

State after the order's execution:
- Some USDC may remain in the user’s wallet as surplus.
- On Aave: 
    - The USDT debt is reduced from 10,000 to 5,000.
    - The USDC collateral is reduced by 400,000.
- The flash loan provider is fully repaid (5,002.5 USDT).